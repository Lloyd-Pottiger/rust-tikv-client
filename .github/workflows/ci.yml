on:
  pull_request:
  push:
    branches:
      - main
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

name: CI

jobs:
  check:
    name: check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v1
        with:
          version: '3.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: make check
        run: make check
      - name: make check-all-features
        run: make check-all-features
      - name: make doc-test
        run: make doc-test
      - name: make doc
        run: make doc
      - name: Catch unexpected changes in the generated code
        run: |
          git diff --exit-code

  coverage:
    name: coverage (non-blocking)
    continue-on-error: true
    env:
      CARGO_INCREMENTAL: 0
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: coverage
        run: make coverage
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: target/llvm-cov/html
          if-no-files-found: ignore

  unit-test:
    name: unit test
    env:
      CARGO_INCREMENTAL: 0
      NEXTEST_PROFILE: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v1
        with:
          version: '3.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install latest nextest release
        uses: taiki-e/install-action@nextest
      - name: unit test
        run: make unit-test

  integration-test:
    name: integration test
    strategy:
      fail-fast: false
      matrix:
        case: ["integration-test-txn", "integration-test-raw"]
    env:
      CARGO_INCREMENTAL: 0
      NEXTEST_PROFILE: ci
      TIKV_VERSION: v8.5.1
      RUST_LOG: info
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v1
        with:
          version: '3.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: install tiup
        run: curl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
      - name: Add tiup to PATH
        run: echo "$HOME/.tiup/bin" >> "$GITHUB_PATH"
      - name: start tiup playground
        run: make tiup-up
      - name: Install latest nextest release
        uses: taiki-e/install-action@nextest
      - name: Integration test
        run: MULTI_REGION=1 make ${{ matrix.case }}
      - name: Collect logs
        if: failure()
        run: |
          set -uo pipefail
          mkdir -p target/tiup-logs

          cp -a target/tiup-playground.log target/tiup-logs/ 2>/dev/null || true
          cp -a target/tiup-playground.name target/tiup-logs/ 2>/dev/null || true
          cp -a target/tiup-playground.pid target/tiup-logs/ 2>/dev/null || true

          if [ -f target/tiup-playground.name ]; then
            name="$(cat target/tiup-playground.name)"
            dir="$(tiup status 2>/dev/null | awk -v name="$name" 'NR>2 && $1==name {print $6; exit}')"
            if [ -n "${dir:-}" ]; then
              cp -a "$dir"/pd-*/pd.log target/tiup-logs/ 2>/dev/null || true
              cp -a "$dir"/tikv-*/tikv.log target/tiup-logs/ 2>/dev/null || true
            fi
          fi

      - name: stop tiup playground
        if: always()
        run: make tiup-down
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cluster-logs
          path: target/tiup-logs
